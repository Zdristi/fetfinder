{% extends "base.html" %}

{% block title %}{{ get_text('gift_conversion') or 'Convert Gifts to Coins' }} - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{ get_text('gift_conversion') or 'Convert Gifts to Coins' }}</h2>
    </div>
    
    <div class="section-title">{{ get_text('available_gifts_for_conversion') or 'Available Gifts for Conversion' }}</div>
    <p>{{ get_text('conversion_rate_info') or 'Convert your received gifts to coins at 50% of their original value' }}</p>
    
    <div id="giftsForConversion" class="gifts-list">
        <div class="loading">{{ get_text('loading') or 'Loading...' }}</div>
    </div>
    
    <div class="section-title" style="margin-top: 30px;">{{ get_text('purchase_premium') or 'Purchase Premium' }}</div>
    
    <div class="premium-packages">
        <div class="package-card">
            <h3>{{ get_text('premium_day') or '1 Day' }}</h3>
            <div class="price">50 {{ get_text('coins') or 'coins' }}</div>
            <button class="btn btn-primary" onclick="purchasePremium('day')">Buy Now</button>
        </div>
        
        <div class="package-card">
            <h3>{{ get_text('premium_week') or '1 Week' }}</h3>
            <div class="price">200 {{ get_text('coins') or 'coins' }}</div>
            <button class="btn btn-primary" onclick="purchasePremium('week')">Buy Now</button>
        </div>
        
        <div class="package-card">
            <h3>{{ get_text('premium_month') or '1 Month' }}</h3>
            <div class="price">500 {{ get_text('coins') or 'coins' }}</div>
            <button class="btn btn-primary" onclick="purchasePremium('month')">Buy Now</button>
        </div>
        
        <div class="package-card">
            <h3>{{ get_text('premium_year') or '1 Year' }}</h3>
            <div class="price">4000 {{ get_text('coins') or 'coins' }}</div>
            <button class="btn btn-primary" onclick="purchasePremium('year')">Buy Now</button>
        </div>
    </div>
    
    <div class="section-title" style="margin-top: 30px;">{{ get_text('premium_features') or 'Premium Features' }}</div>
    
    <div class="premium-features-grid">
        <div class="feature-card">
            <h4>{{ get_text('undo_swipe') or 'Undo Swipe' }}</h4>
            <div class="price">25 {{ get_text('coins') or 'coins' }}</div>
            <p>{{ get_text('undo_swipe_desc') or 'Undo your last swipe' }}</p>
            <button class="btn btn-secondary" onclick="purchaseFeature('undo_swipe')">{{ get_text('buy_now') or 'Buy Now' }}</button>
        </div>
        
        <div class="feature-card">
            <h4>{{ get_text('profile_boost') or 'Profile Boost' }}</h4>
            <div class="price">100 {{ get_text('coins') or 'coins' }}</div>
            <p>{{ get_text('profile_boost_desc') or 'Boost your profile for 30 minutes' }}</p>
            <button class="btn btn-secondary" onclick="purchaseFeature('boost')">{{ get_text('buy_now') or 'Buy Now' }}</button>
        </div>
        
        <div class="feature-card">
            <h4>{{ get_text('profile_highlight') or 'Profile Highlight' }}</h4>
            <div class="price">75 {{ get_text('coins') or 'coins' }}</div>
            <p>{{ get_text('profile_highlight_desc') or 'Highlight your profile for 24 hours' }}</p>
            <button class="btn btn-secondary" onclick="purchaseFeature('highlight_profile')">{{ get_text('buy_now') or 'Buy Now' }}</button>
        </div>
        
        <div class="feature-card">
            <h4>{{ get_text('extended_search') or 'Extended Search' }}</h4>
            <div class="price">50 {{ get_text('coins') or 'coins' }}</div>
            <p>{{ get_text('extended_search_desc') or 'Extended search for 1 day' }}</p>
            <button class="btn btn-secondary" onclick="purchaseFeature('extended_search')">{{ get_text('buy_now') or 'Buy Now' }}</button>
        </div>
    </div>
</div>

<script>
let allGifts = [];

function loadGiftsForConversion() {
    fetch('/api/user_gifts_for_conversion')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            allGifts = data.gifts;
            displayGiftsForConversion(data.gifts);
            document.getElementById('giftsForConversion').innerHTML = `
                <div class="summary">
                    <h3>{{ get_text('total_coins_available') or 'Total Coins Available' }}: <span id="totalCoins">${data.total_available_coins}</span></h3>
                    <button class="btn btn-success" onclick="convertAllGifts()">{{ get_text('convert_all_gifts') or 'Convert All Gifts' }}</button>
                </div>
                <div class="gifts-container">
                    ${data.gifts.map(gift => `
                        <div class="gift-item card gift-selection">
                            <div class="gift-header">
                                <div class="gift-icon">
                                    ${gift.icon ? gift.icon : 'üéÅ'}
                                </div>
                                <div class="gift-info">
                                    <h4>${gift.gift_name}</h4>
                                    <div class="gift-meta">
                                        <span class="sender">{{ get_text('from') or 'From' }} ${gift.sender}</span>
                                        <span class="timestamp">${new Date(gift.timestamp).toLocaleDateString()}</span>
                                    </div>
                                    <p>${gift.gift_description}</p>
                                </div>
                            </div>
                            
                            <div class="gift-conversion">
                                <div class="conversion-info">
                                    <div>{{ get_text('original_price') or 'Original Price' }}: ${gift.original_price} {{ get_text('coins') or 'coins' }}</div>
                                    <div>{{ get_text('conversion_value') or 'Conversion Value' }}: <strong>${gift.conversion_value} {{ get_text('coins') or 'coins' }}</strong></div>
                                </div>
                                <button class="btn btn-info" onclick="convertSingleGift(${gift.id})">{{ get_text('convert_now') or 'Convert Now' }}</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading gifts for conversion:', error);
        document.getElementById('giftsForConversion').innerHTML = `
            <div class="error">{{ get_text('error_loading_gifts') or 'Error loading gifts for conversion' }}</div>
        `;
    });
}

function displayGiftsForConversion(gifts) {
    // Already handled in loadGiftsForConversion function
}

function convertSingleGift(giftId) {
    fetch('/api/convert_gifts_to_coins', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            gift_ids: [giftId]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // Update coins display in header
            document.getElementById('coinsCount').textContent = data.new_balance;
            // Reload gifts list
            loadGiftsForConversion();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error converting gift:', error);
        alert('{{ get_text("error_converting_gift") or "Error converting gift" }}');
    });
}

function convertAllGifts() {
    if (allGifts.length === 0) {
        alert('{{ get_text("no_gifts_to_convert") or "No gifts to convert" }}');
        return;
    }
    
    const giftIds = allGifts.map(gift => gift.id);
    
    fetch('/api/convert_gifts_to_coins', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            gift_ids: giftIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // Update coins display in header
            document.getElementById('coinsCount').textContent = data.new_balance;
            // Reload gifts list
            loadGiftsForConversion();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error converting all gifts:', error);
        alert('{{ get_text("error_converting_gifts") or "Error converting gifts" }}');
    });
}

function purchasePremium(duration) {
    fetch('/api/purchase_premium', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            duration: duration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // Update coins display in header
            document.getElementById('coinsCount').textContent = data.new_balance;
            // Update premium status in header (if available)
            window.location.reload(); // Reload to update premium status
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error purchasing premium:', error);
        alert('{{ get_text("error_purchasing_premium") or "Error purchasing premium" }}');
    });
}

function purchaseFeature(feature) {
    fetch('/api/purchase_premium_feature', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            feature: feature
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // Update coins display in header
            document.getElementById('coinsCount').textContent = data.new_balance;
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error purchasing feature:', error);
        alert('{{ get_text("error_purchasing_feature") or "Error purchasing feature" }}');
    });
}

// Load gifts when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadGiftsForConversion();
});
</script>

<style>
.gifts-list {
    margin-top: 20px;
}

.gifts-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.gift-item {
    display: flex;
    flex-direction: column;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
}

.gift-header {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 10px;
}

.gift-icon {
    font-size: 1.5rem;
    color: var(--primary);
}

.gift-info h4 {
    margin: 0 0 5px 0;
    color: var(--primary);
}

.gift-meta {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.9rem;
    color: var(--gray);
}

.gift-meta .sender, .gift-meta .recipient {
    font-weight: 500;
}

.gift-message {
    margin: 10px 0;
    padding: 10px;
    background-color: var(--light-gray);
    border-radius: 8px;
    font-style: italic;
}

.gift-conversion {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.conversion-info {
    flex-grow: 1;
}

.conversion-info div {
    margin-bottom: 5px;
}

.gift-selection {
    background-color: #f8f9fa;
}

.summary {
    background-color: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}

.summary h3 {
    margin: 0 0 15px 0;
}

.premium-packages {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.package-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.package-card h3 {
    margin: 0 0 10px 0;
    color: var(--primary);
}

.price {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 10px 0;
    color: var(--success);
}

.premium-features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.feature-card h4 {
    margin: 0 0 10px 0;
    color: var(--primary);
}

.feature-card p {
    margin: 10px 0;
    color: var(--gray);
}

.loading, .error {
    text-align: center;
    padding: 40px;
    color: var(--gray);
}

@media (max-width: 768px) {
    .gift-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .gift-conversion {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .premium-packages, .premium-features-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}