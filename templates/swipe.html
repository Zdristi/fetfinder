{% extends "base.html" %}

{% block title %}{{ get_text('discover_matches') }} - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="container">
    <div class="swipe-header">
        <a href="{{ url_for('home') }}" class="btn btn-outline">
            <i class="fas fa-home"></i>
        </a>
        <h1>{{ get_text('discover_matches') }}</h1>
        {% if current_user.is_premium %}
            <span class="premium-badge" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; margin-left: 10px;">
                <i class="fas fa-crown"></i> PREMIUM
            </span>
        {% endif %}
        <a href="{{ url_for('matches') }}" class="btn btn-outline">
            <i class="fas fa-heart"></i>
        </a>
    </div>
    
    <div class="swipe-container" id="swipeContainer">
        <div class="card swipe-card" id="currentCard" style="display: none; position: relative;">
            <div class="user-avatar" id="userAvatar" style="background-size: cover; background-position: center;"></div>
            <div class="user-info">
                <h2 id="username"></h2>
                <p id="location"></p>
                <p id="bio"></p>
                <div id="tags" class="tags-container"></div>
            </div>
            
            <div class="action-hint like-hint" id="likeHint">
                <i class="fas fa-heart"></i> LIKE
            </div>
            <div class="action-hint dislike-hint" id="dislikeHint">
                <i class="fas fa-times"></i> NOPE
            </div>
        </div>
        
        <div class="swipe-actions">
                {% if current_user.is_premium %}
                <button id="undoBtn" class="btn btn-large btn-info" onclick="undoSwipe()" style="display: none;">
                    <i class="fas fa-undo"></i>
                </button>
                {% endif %}
                <button id="rejectBtn" class="btn btn-large btn-danger" onclick="swipe('dislike')">
                    <i class="fas fa-times"></i>
                </button>
                <button id="superlikeBtn" class="btn btn-large btn-warning" onclick="superlike()">
                    <i class="fas fa-star"></i>
                </button>
                <button id="likeBtn" class="btn btn-large btn-success" onclick="swipe('like')">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
    </div>
    
    <div id="noUsersMessage" style="display: none; text-align: center; padding: 50px;">
        <h2>{{ get_text('no_more_users_to_swipe') }}</h2>
        <p>{{ get_text('check_back_later_for_new_users') }}</p>
        <a href="{{ url_for('home') }}" class="btn">{{ get_text('go_home') }}</a>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentUserId = null;
    let users = [];
    let currentIndex = 0;
    let swipeHistory = []; // To store swipe history for undo functionality
    const isPremiumUser = {{ 'true' if current_user.is_premium else 'false' }}; // Pass premium status to JS
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    // Load users on page load
    $(document).ready(function() {
        loadUsers();
        updateUndoButton();
        
        // Setup drag events
        const card = document.getElementById('currentCard');
        card.addEventListener('mousedown', startDrag);
        card.addEventListener('touchstart', startDrag, { passive: false });
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    });

    function loadUsers() {
        $.get('/api/users', function(data) {
            users = data;
            currentIndex = 0;
            if (users.length > 0) {
                showNextUser();
            } else {
                $('#noUsersMessage').show();
                $('#swipeContainer').hide();
            }
        }).fail(function() {
            alert('{{ get_text('error_loading_users') }}');
        });
    }

    function showNextUser() {
        if (currentIndex >= users.length) {
            $('#noUsersMessage').show();
            $('#swipeContainer').hide();
            return;
        }

        const user = users[currentIndex][1];
        currentUserId = users[currentIndex][0];
        
        $('#username').text(user.username);
        $('#location').text((user.city || '') + (user.city && user.country ? ', ' : '') + (user.country || ''));
        $('#bio').text(user.bio || '{{ get_text('no_bio_provided') }}');
        
        // Set avatar
        const avatarDiv = $('#userAvatar');
        if (user.photo) {
            if (user.photo.startsWith('http')) {
                avatarDiv.css('background-image', `url("${user.photo}")`);
            } else {
                avatarDiv.css('background-image', `url("/static/uploads/${user.photo}")`);
            }
        } else {
            avatarDiv.css('background-image', 'none');
            avatarDiv.css('background', 'linear-gradient(135deg, #667eea, #764ba2)');
            avatarDiv.text(user.username[0].toUpperCase());
        }
        
        // Set tags
        const tagsContainer = $('#tags');
        tagsContainer.empty();
        
        if (user.fetishes && user.fetishes.length > 0) {
            user.fetishes.forEach(function(fetish) {
                tagsContainer.append(`<span class="badge badge-fetish">${fetish}</span>`);
            });
        }
        
        if (user.interests && user.interests.length > 0) {
            user.interests.forEach(function(interest) {
                tagsContainer.append(`<span class="badge badge-interest">${interest}</span>`);
            });
        }
        
        // Reset card position
        $('#currentCard').css('transform', 'translateX(0) rotate(0deg)')
                        .css('transition', 'none')
                        .show();
                        
        // Hide action hints
        $('#likeHint').hide();
        $('#dislikeHint').hide();
    }
    
    function startDrag(e) {
        isDragging = true;
        if (e.type === 'touchstart') {
            startX = e.touches[0].clientX;
        } else {
            startX = e.clientX;
        }
        
        $('#currentCard').css('transition', 'none');
    }
    
    function drag(e) {
        if (!isDragging || !currentUserId) return;
        
        e.preventDefault(); // Prevent scrolling while dragging
        
        let clientX;
        if (e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
        } else {
            clientX = e.clientX;
        }
        
        currentX = clientX - startX;
        
        // Move the card
        $('#currentCard').css('transform', `translateX(${currentX}px) rotate(${currentX * 0.1}deg)`);
        
        // Show action hints based on direction
        if (currentX > 50) {
            $('#likeHint').show();
            $('#dislikeHint').hide();
        } else if (currentX < -50) {
            $('#dislikeHint').show();
            $('#likeHint').hide();
        } else {
            $('#likeHint').hide();
            $('#dislikeHint').hide();
        }
    }
    
    function endDrag(e) {
        if (!isDragging || !currentUserId) return;
        
        isDragging = false;
        
        let clientX;
        if (e.type === 'touchend' && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
        } else if (e.type === 'mouseup') {
            clientX = e.clientX;
        }
        
        const diffX = (clientX ? clientX : currentX + startX) - startX;
        
        // Reset transition for smooth animation
        $('#currentCard').css('transition', 'transform 0.3s ease-out, opacity 0.3s ease-out');
        
        if (diffX > 100) {
            // Like action
            performSwipe('like');
        } else if (diffX < -100) {
            // Dislike action
            performSwipe('dislike');
        } else {
            // Return to original position
            $('#currentCard').css('transform', 'translateX(0) rotate(0deg)');
            $('#likeHint').hide();
            $('#dislikeHint').hide();
        }
    }
    
    function performSwipe(action) {
        if (action === 'like') {
            $('#currentCard').addClass('swipe-card-liked');
        } else if (action === 'dislike') {
            $('#currentCard').addClass('swipe-card-disliked');
        }
        
        // Record swipe in history for potential undo (only for premium users, max 5 per day)
        if (isPremiumUser) {
            // Limit undo history to 5 swipes per day
            if (swipeHistory.length >= 5) {
                swipeHistory.shift(); // Remove oldest swipe
            }
            swipeHistory.push({
                userId: currentUserId,
                action: action,
                index: currentIndex  // Store current index
            });
        }

        $.ajax({
            url: '/api/match',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                user2: currentUserId,
                action: action
            }),
            success: function(response) {
                currentIndex++;
                if (response.mutual_match) {
                    alert('It\'s a match! ' + response.matched_user_name + ' liked you too!');
                }
                setTimeout(function() {
                    showNextUser();
                    updateUndoButton();
                }, 300);
            },
            error: function() {
                alert('Error processing swipe');
                // Return card to original position
                $('#currentCard').removeClass('swipe-card-liked swipe-card-disliked')
                                .css('transform', 'translateX(0) rotate(0deg)');
            }
        });
    }

    function swipe(action) {
        // Function for button clicks
        if (!currentUserId) return;

        performSwipe(action);
    }

    function superlike() {
        // For now, superlike works the same as like
        swipe('like');
    }

    function undoSwipe() {
            if (!isPremiumUser) {
                alert('Undo swipe is a premium feature! Upgrade to premium to use this feature.');
                return;
            }

            if (swipeHistory.length === 0) {
                alert('No swipes to undo!');
                return;
            }

            // Get the last swipe
            const lastSwipe = swipeHistory.pop();
            
            // Call the backend to undo the swipe
            $.ajax({
                url: '/api/undo_swipe',
                method: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        // Go back to the previous user
                        currentIndex = lastSwipe.index;
                        showNextUser();
                        updateUndoButton();
                    } else {
                        alert('Error undoing swipe: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error contacting server to undo swipe');
                }
            });
        }

    function updateUndoButton() {
            if (isPremiumUser) {
                const undoBtn = $('#undoBtn');
                if (swipeHistory.length > 0) {
                    undoBtn.show();
                } else {
                    undoBtn.hide();
                }
            }
        }
</script>
{% endblock %}