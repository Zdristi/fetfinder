{% extends \"base.html\" %}\n\n{% block title %}{{ get_text('discover_matches') }} - {{ SITE_NAME }}{% endblock %}\n\n{% block content %}\n<div class=\"container\">\n    <div class=\"swipe-header\">\n        <a href=\"{{ url_for('home') }}\" class=\"btn btn-outline\">\n            <i class=\"fas fa-home\"></i>\n        </a>\n        <h1>{{ get_text('discover_matches') }}</h1>\n        {% if current_user.is_premium %}\n            <span class=\"premium-badge\" style=\"background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; margin-left: 10px;\">\n                <i class=\"fas fa-crown\"></i> PREMIUM\n            </span>\n        {% endif %}\n        <a href=\"{{ url_for('matches') }}\" class=\"btn btn-outline\">\n            <i class=\"fas fa-heart\"></i>\n        </a>\n    </div>\n    \n    <div class=\"swipe-container\" id=\"swipeContainer\" style=\"position: relative; min-height: 500px;\">\n        <div class=\"card swipe-card\" id=\"currentCard\" style=\"display: none; position: relative; margin: 20px auto; max-width: 400px;\">\n            <div class=\"user-avatar\" id=\"userAvatar\" style=\"width: 100%; height: 300px; background-size: cover; background-position: center; border-radius: 10px 10px 0 0;\"></div>\n            <div class=\"user-info\" style=\"padding: 20px;\">\n                <h2 id=\"username\"></h2>\n                <p id=\"location\"></p>\n                <p id=\"bio\"></p>\n                <div id=\"tags\" class=\"tags-container\" style=\"display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;\"></div>\n            </div>\n            \n            <div class=\"action-hint like-hint\" id=\"likeHint\">\n                <i class=\"fas fa-heart\"></i> LIKE\n            </div>\n            <div class=\"action-hint dislike-hint\" id=\"dislikeHint\">\n                <i class=\"fas fa-times\"></i> NOPE\n            </div>\n        </div>\n        \n        <div id=\"noUsersMessage\" style=\"display: none; text-align: center; padding: 50px;\">\n            <h2>{{ get_text('no_more_users_to_swipe') }}</h2>\n            <p>{{ get_text('check_back_later_for_new_users') }}</p>\n            <a href=\"{{ url_for('home') }}\" class=\"btn\">{{ get_text('go_home') }}</a>\n        </div>\n    </div>\n    \n    <div class=\"swipe-actions\" style=\"position: fixed; bottom: 30px; width: 100%; max-width: 500px; left: 50%; transform: translateX(-50%); z-index: 1000;\">\n        <div class=\"actions-container\">\n            {% if current_user.is_premium %}\n            <button id=\"undoBtn\" class=\"btn btn-large btn-info\" onclick=\"undoSwipe()\" style=\"display: none;\">\n                <i class=\"fas fa-undo\"></i>\n            </button>\n            {% endif %}\n            <button id=\"rejectBtn\" class=\"btn btn-large btn-danger\" onclick=\"swipe('dislike')\">\n                <i class=\"fas fa-times\"></i>\n            </button>\n            <button id=\"messageBtn\" class=\"btn btn-large btn-primary\" onclick=\"messageUser()\">\n                <i class=\"fas fa-comment\"></i>\n            </button>\n            <button id=\"superlikeBtn\" class=\"btn btn-large btn-warning\" onclick=\"superlike()\">\n                <i class=\"fas fa-star\"></i>\n            </button>\n            <button id=\"likeBtn\" class=\"btn btn-large btn-success\" onclick=\"swipe('like')\">\n                <i class=\"fas fa-heart\"></i>\n            </button>\n        </div>\n    </div>\n</div>\n\n<script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\n<script>\n    let currentUserId = null;\n    let users = [];\n    let currentIndex = 0;\n    let swipeHistory = []; // To store swipe history for undo functionality\n    const isPremiumUser = {{ 'true' if current_user.is_premium else 'false' }}; // Pass premium status to JS\n    let startX = 0;\n    let currentX = 0;\n    let isDragging = false;\n    \n    // Load users on page load\n    $(document).ready(function() {\n        loadUsers();\n        updateUndoButton();\n        \n        // Setup drag events\n        const card = document.getElementById('currentCard');\n        if (card) {\n            card.addEventListener('mousedown', startDrag);\n            card.addEventListener('touchstart', startDrag, { passive: false });\n            \n            document.addEventListener('mousemove', drag);\n            document.addEventListener('touchmove', drag, { passive: false });\n            \n            document.addEventListener('mouseup', endDrag);\n            document.addEventListener('touchend', endDrag);\n        }\n    });\n\n    function loadUsers() {\n        $.get('/api/users', function(data) {\n            users = data;\n            currentIndex = 0;\n            if (users.length > 0) {\n                showNextUser();\n            } else {\n                $('#noUsersMessage').show();\n                $('#swipeContainer').hide();\n            }\n        }).fail(function(xhr, status, error) {\n            console.error('Error loading users:', error);\n            alert('Error loading users: ' + error);\n        });\n    }\n\n    function showNextUser() {\n        if (currentIndex >= users.length) {\n            $('#noUsersMessage').show();\n            $('#swipeContainer').hide();\n            return;\n        }\n\n        const user = users[currentIndex][1];\n        currentUserId = users[currentIndex][0];\n        \n        $('#username').text(user.username || 'Anonymous');\n        $('#location').text((user.city || '') + (user.city && user.country ? ', ' : '') + (user.country || ''));\n        $('#bio').text(user.bio || 'No bio provided');\n        \n        // Set avatar\n        const avatarDiv = $('#userAvatar');\n        if (user.photo) {\n            if (user.photo.startsWith('http')) {\n                avatarDiv.css('background-image', 'url(\"' + user.photo + '\")');\n            } else {\n                avatarDiv.css('background-image', 'url(\"/static/uploads/' + user.photo + '\")');\n            }\n        } else {\n            avatarDiv.css('background-image', 'none');\n            avatarDiv.css('background', 'linear-gradient(135deg, #667eea, #764ba2)');\n            avatarDiv.text((user.username || '?')[0].toUpperCase());\n        }\n        \n        // Set tags\n        const tagsContainer = $('#tags');\n        tagsContainer.empty();\n        \n        if (user.fetishes && user.fetishes.length > 0) {\n            user.fetishes.slice(0, 5).forEach(function(fetish) { // Show max 5 fetishes\n                tagsContainer.append('<span class=\"badge badge-fetish\">' + fetish + '</span>');\n            });\n        }\n        \n        if (user.interests && user.interests.length > 0) {\n            user.interests.slice(0, 5).forEach(function(interest) { // Show max 5 interests\n                tagsContainer.append('<span class=\"badge badge-interest\">' + interest + '</span>');\n            });\n        }\n        \n        // Reset card position\n        $('#currentCard').css('transform', 'translateX(0) rotate(0deg)')\n                        .css('transition', 'none')\n                        .show();\n                        \n        // Hide action hints\n        $('#likeHint').hide();\n        $('#dislikeHint').hide();\n    }\n    \n    function startDrag(e) {\n        isDragging = true;\n        if (e.type === 'touchstart') {\n            startX = e.touches[0].clientX;\n        } else {\n            startX = e.clientX;\n        }\n        \n        $('#currentCard').css('transition', 'none');\n    }\n    \n    function drag(e) {\n        if (!isDragging || !currentUserId) return;\n        \n        e.preventDefault(); // Prevent scrolling while dragging\n        \n        let clientX;\n        if (e.type === 'touchmove') {\n            clientX = e.touches[0].clientX;\n        } else {\n            clientX = e.clientX;\n        }\n        \n        currentX = clientX - startX;\n        \n        // Move the card\n        $('#currentCard').css('transform', 'translateX(' + currentX + 'px) rotate(' + (currentX * 0.1) + 'deg)');\n        \n        // Show action hints based on direction\n        if (currentX > 50) {\n            $('#likeHint').show();\n            $('#dislikeHint').hide();\n        } else if (currentX < -50) {\n            $('#dislikeHint').show();\n            $('#likeHint').hide();\n        } else {\n            $('#likeHint').hide();\n            $('#dislikeHint').hide();\n        }\n    }\n    \n    function endDrag(e) {\n        if (!isDragging || !currentUserId) return;\n        \n        isDragging = false;\n        \n        let clientX;\n        if (e.type === 'touchend' && e.changedTouches.length > 0) {\n            clientX = e.changedTouches[0].clientX;\n        } else if (e.type === 'mouseup') {\n            clientX = e.clientX;\n        }\n        \n        const diffX = (clientX ? clientX : currentX + startX) - startX;\n        \n        // Reset transition for smooth animation\n        $('#currentCard').css('transition', 'transform 0.3s ease-out, opacity 0.3s ease-out');\n        \n        if (diffX > 100) {\n            // Like action\n            performSwipe('like');\n        } else if (diffX < -100) {\n            // Dislike action\n            performSwipe('dislike');\n        } else {\n            // Return to original position\n            $('#currentCard').css('transform', 'translateX(0) rotate(0deg)');\n            $('#likeHint').hide();\n            $('#dislikeHint').hide();\n        }\n    }\n    \n    function performSwipe(action) {\n        if (action === 'like') {\n            $('#currentCard').addClass('swipe-card-liked');\n        } else if (action === 'dislike') {\n            $('#currentCard').addClass('swipe-card-disliked');\n        }\n        \n        // Record swipe in history for potential undo (only for premium users, max 5 per day)\n        if (isPremiumUser) {\n            // Limit undo history to 5 swipes per day\n            if (swipeHistory.length >= 5) {\n                swipeHistory.shift(); // Remove oldest swipe\n            }\n            swipeHistory.push({\n                userId: currentUserId,\n                action: action,\n                index: currentIndex  // Store current index\n            });\n        }\n\n        $.ajax({\n            url: '/api/match',\n            method: 'POST',\n            contentType: 'application/json',\n            data: JSON.stringify({\n                user2: currentUserId,\n                action: action\n            }),\n            success: function(response) {\n                currentIndex++;\n                if (response.mutual_match) {\n                    alert('It\\'s a match! ' + response.matched_user_name + ' liked you too!');\n                }\n                setTimeout(function() {\n                    showNextUser();\n                    updateUndoButton();\n                }, 300);\n            },\n            error: function(xhr, status, error) {\n                console.error('Error processing swipe:', error);\n                alert('Error processing swipe: ' + error);\n                // Return card to original position\n                $('#currentCard').removeClass('swipe-card-liked swipe-card-disliked')\n                                .css('transform', 'translateX(0) rotate(0deg)');\n            }\n        });\n    }\n\n    function swipe(action) {\n        // Function for button clicks\n        if (!currentUserId) return;\n\n        performSwipe(action);\n    }\n\n    function superlike() {\n        // For now, superlike works the same as like\n        swipe('like');\n    }\n    \n    function messageUser() {\n        if (!currentUserId) return;\n        \n        // Check if user is premium or has remaining messages\n        if (!isPremiumUser) {\n            // For non-premium users, check daily message limit\n            // In a real app, you'd check against the backend\n            // For now, we'll just allow it but show a warning\n            if (confirm(\"Free users can only send 1 message per day. Upgrade to Premium for unlimited messaging. Continue?\")) {\n                // Allow message to be sent but warn the user\n            } else {\n                return; // User cancelled\n            }\n        }\n        \n        // Open chat with the user\n        window.location.href = '/chat/' + currentUserId;\n    }\n\n    function undoSwipe() {\n        if (!isPremiumUser) {\n            alert('Undo swipe is a premium feature! Upgrade to premium to use this feature.');\n            return;\n        }\n\n        if (swipeHistory.length === 0) {\n            alert('No swipes to undo!');\n            return;\n        }\n\n        // Get the last swipe\n        const lastSwipe = swipeHistory.pop();\n        \n        // Call the backend to undo the swipe\n        $.ajax({\n            url: '/api/undo_swipe',\n            method: 'POST',\n            success: function(response) {\n                if (response.status === 'success') {\n                    // Go back to the previous user\n                    currentIndex = lastSwipe.index;\n                    showNextUser();\n                    updateUndoButton();\n                } else {\n                    alert('Error undoing swipe: ' + response.error);\n                }\n            },\n            error: function(xhr, status, error) {\n                console.error('Error contacting server to undo swipe:', error);\n                alert('Error contacting server to undo swipe: ' + error);\n            }\n        });\n    }\n\n    function updateUndoButton() {\n        if (isPremiumUser) {\n            const undoBtn = $('#undoBtn');\n            if (swipeHistory.length > 0) {\n                undoBtn.show();\n            } else {\n                undoBtn.hide();\n            }\n        }\n    }\n</script>\n<style>\n    .swipe-card {\n        position: relative;\n        transition: transform 0.2s ease-out, opacity 0.2s ease-out;\n        cursor: grab;\n    }\n    \n    .swipe-card:active {\n        cursor: grabbing;\n    }\n    \n    .swipe-card-liked {\n        transform: translateX(150%) rotate(20deg);\n        opacity: 0;\n    }\n    \n    .swipe-card-disliked {\n        transform: translateX(-150%) rotate(-20deg);\n        opacity: 0;\n    }\n    \n    .action-hint {\n        position: absolute;\n        top: 20px;\n        background: rgba(255,255,255,0.9);\n        padding: 5px 10px;\n        border-radius: 15px;\n        font-size: 0.8em;\n        display: none;\n    }\n    \n    .like-hint {\n        right: 20px;\n        color: var(--success);\n    }\n    \n    .dislike-hint {\n        left: 20px;\n        color: var(--danger);\n    }\n    \n    .swipe-actions {\n        position: fixed;\n        bottom: 20px;\n        width: 100%;\n        max-width: 500px;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 1000;\n    }\n    \n    .actions-container {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        gap: 15px;\n        padding: 20px;\n        flex-wrap: wrap;\n    }\n    \n    .btn.btn-large {\n        width: 60px;\n        height: 60px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 0;\n        font-size: 1.2em;\n    }\n    \n    .btn.btn-info { /* undo button */\n        background: #17a2b8;\n        border-color: #17a2b8;\n    }\n    \n    .btn.btn-info:hover {\n        background: #138496;\n        border-color: #117a8b;\n    }\n    \n    .btn.btn-primary { /* message button */\n        background: #007bff;\n        border-color: #007bff;\n    }\n    \n    .btn.btn-primary:hover {\n        background: #0069d9;\n        border-color: #0062cc;\n    }\n</style>\n{% endblock %}