{% extends "base.html" %}

{% block title %}{{ get_text('discover_matches') }} - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="container">
    <div class="swipe-header">
        <h1>{{ get_text('discover_matches') }}</h1>

    </div>
    
    <div id="swipeContainer" style="position: relative; min-height: 500px;">
        <div class="swipe-container">
            <div class="card swipe-card" id="currentCard" style="display: none; position: relative; margin: 20px auto; max-width: 400px;">
                <div class="user-avatar" id="userAvatar" style="width: 100%; height: 300px; background-size: cover; background-position: center; border-radius: 10px 10px 0 0;"></div>
                <div class="user-info" style="padding: 20px;">
                    <h2 id="username"><span id="premiumBadge" style="display: none;"></span></h2>
                    <p id="location"></p>
                    <p id="bio"></p>
                    <div id="tags" class="tags-container" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;"></div>
                </div>
                
                <div class="action-hint like-hint" id="likeHint">
                    <i class="fas fa-heart"></i> LIKE
                </div>
                <div class="action-hint dislike-hint" id="dislikeHint">
                    <i class="fas fa-times"></i> NOPE
                </div>
            </div>
        </div>
    </div>
    
    <div id="noUsersMessage" style="display: none; text-align: center; padding: 20px; margin: -150px auto 0; max-width: 80%; position: relative; z-index: 10;">
        <h2 style="margin: 10px 0; font-size: 1.8rem;">{{ get_text('no_more_users') }}</h2>
        <p style="margin: 10px 0; font-size: 1.2rem;">{{ get_text('check_later') }}</p>
    </div>
    
    <div class="swipe-actions" style="position: fixed; bottom: 30px; width: 100%; max-width: 500px; left: 50%; transform: translateX(-50%); z-index: 1000;">
        <div class="actions-container">

            <button id="undoBtn" class="btn btn-large btn-info" onclick="undoSwipe()" style="display: none;">
                <i class="fas fa-undo"></i>
            </button>
            <button id="rejectBtn" class="btn btn-large btn-danger" onclick="swipe('dislike')">
                <i class="fas fa-times"></i>
            </button>
            <button id="messageBtn" class="btn btn-large btn-primary" onclick="openMessageModal()">
                <i class="fas fa-comment"></i>
            </button>
            <button id="superlikeBtn" class="btn btn-large btn-warning" onclick="superlike()">
                <i class="fas fa-star"></i>
            </button>
            <button id="likeBtn" class="btn btn-large btn-success" onclick="swipe('like')">
                <i class="fas fa-heart"></i>
            </button>
        </div>
    </div>
    
    <!-- Message Modal -->
    <div id="messageModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: var(--card-bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; position: relative;">
            <span class="close" onclick="closeMessageModal()" style="position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-color);">&times;</span>
            
            <h3>Send a message instead of just liking</h3>
            
            {% if not isPremiumUser %}
                <div class="message-limit-info" style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                    <strong>Note:</strong> You have 1 free message per day. Upgrade to Premium for unlimited messaging.
                </div>
            {% endif %}
            
            <textarea id="messageInput" placeholder="Write your message here..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-color); color: var(--text-color); resize: vertical; margin-bottom: 15px;"></textarea>
            
            <div class="modal-actions" style="display: flex; justify-content: space-between;">
                <button class="btn btn-outline" onclick="closeMessageModal()">Cancel</button>
                <button id="sendMessageBtn" class="btn btn-success" onclick="sendMessageInsteadOfLike()">Send Message</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentUserId = null;
    let users = [];
    let currentIndex = 0;
    let swipeHistory = []; // To store swipe history for undo functionality
    const isPremiumUser = false; // Premium functionality removed
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    // Load users on page load
    $(document).ready(function() {
        loadUsers();
        updateUndoButton();
        
        // Setup drag events
        const card = document.getElementById('currentCard');
        if (card) {
            card.addEventListener('mousedown', startDrag);
            card.addEventListener('touchstart', startDrag, { passive: false });
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }
    });

    function loadUsers() {
        console.log('Loading users from API...');
        $.get('/api/users', function(data) {
            console.log('Received users data:', data);
            users = data;
            currentIndex = 0;
            if (users.length > 0) {
                console.log('Showing first user...');
                showNextUser();
            } else {
                console.log('No users to show');
                $('#noUsersMessage').show();
                $('.swipe-container').hide();
            }
        }).fail(function(xhr, status, error) {
            console.error('Error loading users:', error);
            console.error('Response:', xhr.responseText);
            alert('Error loading users: ' + error);
        });
    }

    function loadNextUser() {
        // Load a single user instead of the entire list
        console.log('Loading next user from API...');
        $.get('/api/users', function(data) {
            console.log('API returned:', data);
            if (data && data.length > 0) {
                console.log('Loaded ' + data.length + ' users from API');
                // Reset the internal state for a single user
                users = data;
                currentIndex = 0;
                showNextUser();
            } else {
                console.log('No more users to show - API returned empty array');
                $('#noUsersMessage').show();
                $('.swipe-container').hide();
            }
        }).fail(function(xhr, status, error) {
            console.error('Error loading next user:', error);
            console.error('Response:', xhr.responseText);
            alert('Error loading next user: ' + error);
        });
    }

    function showNextUser() {
        console.log('Showing user at index:', currentIndex);
        console.log('Total users:', users.length);
        
        if (currentIndex >= users.length) {
            // Try to load more users
            console.log('Current index exceeds array length, loading next user from API');
            loadNextUser();
            return;
        }

        const userData = users[currentIndex];
        console.log('User data structure:', userData);
        
        // Check if data structure is correct
        if (!userData || userData.length < 2) {
            console.error('Invalid user data structure:', userData);
            currentIndex++;
            showNextUser(); // Try next user
            return;
        }
        
        const user = userData[1];
        currentUserId = userData[0];
        
        console.log('Displaying user:', user);
        
        $('#username').text(user.username || 'Anonymous');
        $('#location').text((user.city || '') + (user.city && user.country ? ', ' : '') + (user.country || ''));
        $('#bio').text(user.bio || 'No bio provided');
        
        // Set avatar
        const avatarDiv = $('#userAvatar');
        if (user.photo) {
            if (user.photo.startsWith('http')) {
                avatarDiv.css('background-image', 'url("' + user.photo + '")');
            } else {
                avatarDiv.css('background-image', 'url("/static/uploads/' + user.photo + '")');
            }
        } else {
            avatarDiv.css('background-image', 'none');
            avatarDiv.css('background', 'linear-gradient(135deg, #667eea, #764ba2)');
            avatarDiv.text((user.username || '?')[0].toUpperCase());
        }
        
        // Set tags
        const tagsContainer = $('#tags');
        tagsContainer.empty();
        
        if (user.fetishes && user.fetishes.length > 0) {
            user.fetishes.slice(0, 5).forEach(function(fetish) { // Show max 5 fetishes
                tagsContainer.append('<span class="badge badge-fetish">' + fetish + '</span>');
            });
        }
        
        if (user.interests && user.interests.length > 0) {
            user.interests.slice(0, 5).forEach(function(interest) { // Show max 5 interests
                tagsContainer.append('<span class="badge badge-interest">' + interest + '</span>');
            });
        }
        
        // Reset card position
        $('#currentCard').css('transform', 'translateX(0) rotate(0deg)')
                        .css('transition', 'none')
                        .show();
                        
        // Hide action hints
        $('#likeHint').hide();
        $('#dislikeHint').hide();
    }
    
    function startDrag(e) {
        isDragging = true;
        if (e.type === 'touchstart') {
            startX = e.touches[0].clientX;
        } else {
            startX = e.clientX;
        }
        
        $('#currentCard').css('transition', 'none');
    }
    
    function drag(e) {
        if (!isDragging || !currentUserId) return;
        
        e.preventDefault(); // Prevent scrolling while dragging
        
        let clientX;
        if (e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
        } else {
            clientX = e.clientX;
        }
        
        currentX = clientX - startX;
        
        // Move the card
        $('#currentCard').css('transform', 'translateX(' + currentX + 'px) rotate(' + (currentX * 0.1) + 'deg)');
        
        // Show action hints based on direction
        if (currentX > 50) {
            $('#likeHint').show();
            $('#dislikeHint').hide();
        } else if (currentX < -50) {
            $('#dislikeHint').show();
            $('#likeHint').hide();
        } else {
            $('#likeHint').hide();
            $('#dislikeHint').hide();
        }
    }
    
    function endDrag(e) {
        if (!isDragging || !currentUserId) return;
        
        isDragging = false;
        
        let clientX;
        if (e.type === 'touchend' && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
        } else if (e.type === 'mouseup') {
            clientX = e.clientX;
        }
        
        const diffX = (clientX ? clientX : currentX + startX) - startX;
        
        // Reset transition for smooth animation
        $('#currentCard').css('transition', 'transform 0.3s ease-out, opacity 0.3s ease-out');
        
        if (diffX > 100) {
            // Like action
            performSwipe('like');
        } else if (diffX < -100) {
            // Dislike action
            performSwipe('dislike');
        } else {
            // Return to original position
            $('#currentCard').css('transform', 'translateX(0) rotate(0deg)');
            $('#likeHint').hide();
            $('#dislikeHint').hide();
        }
    }
    
    function performSwipe(action) {
        if (action === 'like') {
            $('#currentCard').addClass('swipe-card-liked');
        } else if (action === 'dislike') {
            $('#currentCard').addClass('swipe-card-disliked');
        }
        
        // Record swipe in history for potential undo (only for premium users, max 5 per day)
        if (isPremiumUser) {
            // Limit undo history to 5 swipes per day
            if (swipeHistory.length >= 5) {
                swipeHistory.shift(); // Remove oldest swipe
            }
            swipeHistory.push({
                userId: currentUserId,
                action: action,
                index: currentIndex  // Store current index
            });
        }

        $.ajax({
            url: '/api/match',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                user2: currentUserId,
                action: action
            }),
            success: function(response) {
                currentIndex++;
                if (response.mutual_match) {
                    alert('It\'s a match! ' + response.matched_user_name + ' liked you too!');
                }
                setTimeout(function() {
                    loadNextUser();
                    updateUndoButton();
                }, 300);
            },
            error: function(xhr, status, error) {
                console.error('Error processing swipe:', error);
                alert('Error processing swipe: ' + error);
                // Return card to original position
                $('#currentCard').removeClass('swipe-card-liked swipe-card-disliked')
                                .css('transform', 'translateX(0) rotate(0deg)');
            }
        });
    }

    function swipe(action) {
        // Function for button clicks
        if (!currentUserId) return;

        performSwipe(action);
    }

    function superlike() {
        // For now, superlike works the same as like
        swipe('like');
    }
    
    function openMessageModal() {
        if (!currentUserId) return;
        
        // Check if user is premium or has remaining messages
        if (!isPremiumUser) {
            // Check daily message limit via AJAX
            $.get('/api/message_limit_check', function(response) {
                if (response.status === 'error' && response.limit_reached) {
                    alert('Free users can only send 1 message per day. Upgrade to Premium for unlimited messaging!');
                    return;
                } else {
                    $('#messageModal').show();
                    $('#messageInput').focus();
                }
            }).fail(function() {
                // If API call fails, proceed with old confirmation method
                if (confirm("Free users can only send 1 message per day. Upgrade to Premium for unlimited messaging. Continue?")) {
                    $('#messageModal').show();
                    $('#messageInput').focus();
                }
            });
        } else {
            // Premium users can always send messages
            $('#messageModal').show();
            $('#messageInput').focus();
        }
    }
    
    function closeMessageModal() {
        $('#messageModal').hide();
        $('#messageInput').val('');
    }
    
    function sendMessageInsteadOfLike() {
        if (!currentUserId) return;
        
        const messageContent = $('#messageInput').val().trim();
        if (!messageContent) {
            alert('Please enter a message');
            return;
        }
        
        // Send the message via AJAX
        $.ajax({
            url: '/api/send_message',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                recipient_id: currentUserId,
                content: messageContent
            }),
            success: function(response) {
                if (response.status === 'success') {
                    // Message sent successfully, now also like the user
                    performSwipe('like');
                    closeMessageModal();
                    alert('Message sent successfully!');
                } else {
                    alert('Error sending message: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error);
            }
        });
    }
    
    function messageUser() {
        if (!currentUserId) return;
        
        // Check if user is premium or has remaining messages
        if (!isPremiumUser) {
            // For non-premium users, check daily message limit
            // In a real app, you'd check against the backend
            // For now, we'll just allow it but show a warning
            if (confirm("Free users can only send 1 message per day. Upgrade to Premium for unlimited messaging. Continue?")) {
                // Allow message to be sent but warn the user
            } else {
                return; // User cancelled
            }
        }
        
        // Open chat with the user
        window.location.href = '/chat/' + currentUserId;
    }

    function undoSwipe() {
        if (!isPremiumUser) {
            alert('Undo swipe is a premium feature! Upgrade to premium to use this feature.');
            return;
        }

        if (swipeHistory.length === 0) {
            alert('No swipes to undo!');
            return;
        }

        // Get the last swipe
        const lastSwipe = swipeHistory.pop();
        
        // Call the backend to undo the swipe
        $.ajax({
            url: '/api/undo_swipe',
            method: 'POST',
            success: function(response) {
                if (response.status === 'success') {
                    // Go back to the previous user
                    currentIndex = lastSwipe.index;
                    showNextUser();
                    updateUndoButton();
                } else {
                    alert('Error undoing swipe: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error contacting server to undo swipe:', error);
                alert('Error contacting server to undo swipe: ' + error);
            }
        });
    }

    function updateUndoButton() {
        if (isPremiumUser) {
            const undoBtn = $('#undoBtn');
            if (swipeHistory.length > 0) {
                undoBtn.show();
            } else {
                undoBtn.hide();
            }
        }
    }
</script>
<style>
    .swipe-card {
        position: relative;
        transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        cursor: grab;
    }
    
    .swipe-card:active {
        cursor: grabbing;
    }
    
    .swipe-card-liked {
        transform: translateX(150%) rotate(20deg);
        opacity: 0;
    }
    
    .swipe-card-disliked {
        transform: translateX(-150%) rotate(-20deg);
        opacity: 0;
    }
    
    .action-hint {
        position: absolute;
        top: 20px;
        background: rgba(255,255,255,0.9);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        display: none;
    }
    
    .like-hint {
        right: 20px;
        color: var(--success);
    }
    
    .dislike-hint {
        left: 20px;
        color: var(--danger);
    }
    
    .swipe-actions {
        position: fixed;
        bottom: 20px;
        width: 100%;
        max-width: 500px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
    }
    
    .actions-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        padding: 20px;
        flex-wrap: wrap;
    }
    
    .btn.btn-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 1.2em;
    }
    
    .btn.btn-info { /* undo button */
        background: #17a2b8;
        border-color: #17a2b8;
    }
    
    .btn.btn-info:hover {
        background: #138496;
        border-color: #117a8b;
    }
    
    .btn.btn-primary { /* message button */
        background: #007bff;
        border-color: #007bff;
    }
    
    .btn.btn-primary:hover {
        background: #0069d9;
        border-color: #0062cc;
    }
    
    .logo-link {
        text-decoration: none;
        color: inherit;
        display: flex;
        align-items: center;
    }
    
    .logo {
        display: flex;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: inherit;
    }
    
    .logo i {
        margin-right: 8px;
    }
    
    #noUsersMessage {
        display: none;
        text-align: center;
        padding: 50px;
        position: relative;
        z-index: 10;
    }
</style>
{% endblock %}