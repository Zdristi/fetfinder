{% extends "base.html" %}

{% block title %}{{ user_data.username or 'Profile' }} - LoveConnect{% endblock %}

{% block content %}
<div class="card">
    <div class="profile-header">
        {% if user_data.photo %}
            <img src="{{ url_for('static', filename='uploads/' + user_data.photo) if user_data.photo and not user_data.photo.startswith('http') else user_data.photo }}" 
                 alt="{{ user_data.username }}" class="profile-avatar" style="width: 100px; height: 100px; object-fit: cover;">
        {% else %}
            <div class="profile-avatar">
                {{ user_data.username[0].upper() if user_data.username else '?' }}
            </div>
        {% endif %}
        <div class="profile-info">
            <h1>
                {{ user_data.username or 'Anonymous' }}
                {% if user_data.is_premium %}
                    <span class="premium-badge" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 10px;">
                        <i class="fas fa-crown"></i> PREMIUM
                    </span>
                {% endif %}
            </h1>
            {% if user_data.country or user_data.city %}
                <p>
                    <i class="fas fa-map-marker-alt"></i> 
                    {{ user_data.city }}{% if user_data.city and user_data.country %}, {% endif %}{{ user_data.country }}
                </p>
            {% endif %}
            <p><i class="fas fa-calendar-alt"></i> {{ get_text('member_since') }} {{ user_data.created_at[:10] }}</p>
        </div>
    </div>
    
    {% if not is_complete %}
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffeaa7;">
            <p style="margin: 0; color: #856404;">
                <i class="fas fa-exclamation-circle"></i> {{ get_text('please_complete_profile') }}
            </p>
            <a href="{{ url_for('edit_profile') }}" class="btn" style="margin-top: 10px; padding: 8px 15px; font-size: 0.9rem;">
                {{ get_text('complete_profile') }}
            </a>
        </div>
    {% endif %}
    
    <div class="section-title">
        <h2 class="section-title-text"><i class="fas fa-user-circle"></i> {{ get_text('about') }}</h2>
    </div>
    <p>{{ user_data.bio or get_text('no_bio') }}</p>
    
    <div class="section-title">
        <h2 class="section-title-text"><i class="fas fa-fire"></i> {{ get_text('fetishes') }}</h2>
    </div>
    {% if user_data.fetishes %}
        <div>
            {% for fetish in user_data.fetishes %}
                <span class="badge badge-fetish">{{ fetish }}</span>
            {% endfor %}
        </div>
    {% else %}
        <p>{{ get_text('no_fetishes') }}</p>
    {% endif %}
    
    <div class="section-title">
        <h2 class="section-title-text"><i class="fas fa-heart"></i> {{ get_text('interests') }}</h2>
    </div>
    {% if user_data.interests %}
        <div>
            {% for interest in user_data.interests %}
                <span class="badge badge-interest">{{ interest }}</span>
            {% endfor %}
        </div>
    {% else %}
        <p>{{ get_text('no_interests') }}</p>
    {% endif %}
    
    <!-- Star Rating Form (only for other users, not for the profile owner) -->
    {% if current_user.id != user_data.id %}
        <script>console.log('Rating UI displayed: current_user.id ({{ current_user.id }}) != user_data.id ({{ user_data.id }})');</script>
        <div class="section-title">
            <h2 class="section-title-text"><i class="fas fa-star"></i> {{ get_text('rate_this_user') or 'Rate This User' }}</h2>
        </div>
        <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--border-color);">
            <div style="margin-bottom: 15px;">
                <label class="form-label">{{ get_text('your_rating') or 'Your Rating:' }}</label>
                <div id="rating-input" style="display: flex; justify-content: flex-start; gap: 5px;">
                    {% for i in range(1, 6) %}
                        <span class="star-rating" data-rating="{{ i }}" style="font-size: 2rem; cursor: pointer; color: var(--gray);">
                            <i class="far fa-star"></i>
                        </span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Submit Button -->
            <button id="submit-rating-btn" class="btn" style="padding: 10px 20px; display: none;" data-user-id="{{ user_data.id }}">
                {{ get_text('submit_rating') or 'Submit Rating' }}
            </button>
        </div>
    {% else %}
        <script>console.log('Rating UI not displayed: current_user.id ({{ current_user.id }}) == user_data.id ({{ user_data.id }}) - user viewing own profile or not logged in');</script>
    {% endif %}
    

<script>
    // Simple star rating functionality
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Simple star rating system loaded');
        const stars = document.querySelectorAll('.star-rating');
        const submitBtn = document.getElementById('submit-rating-btn');
        let selectedRating = 0;
        
        console.log('Found ' + stars.length + ' star elements');
        console.log('Submit button exists: ' + (submitBtn !== null));
        
        // Add click handlers to stars if they exist
        if (stars.length > 0) {
            console.log('Adding event listeners to stars');
            
            stars.forEach((star, index) => {
                // Click event
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    console.log('Star clicked! Rating: ' + selectedRating);
                    
                    // Update all stars display
                    stars.forEach((s, i) => {
                        const icon = s.querySelector('i');
                        if (i < selectedRating) {
                            icon.className = 'fas fa-star';
                            s.style.color = '#ffc107';
                        } else {
                            icon.className = 'far fa-star';
                            s.style.color = '#ccc';
                        }
                    });
                    
                    // Show submit button
                    if (submitBtn) {
                        submitBtn.style.display = 'inline-block';
                        console.log('Submit button shown');
                    }
                });
                
                // Hover effect
                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    console.log('Mouse entered star ' + hoverRating);
                    
                    // Temporarily highlight stars up to hover position
                    stars.forEach((s, i) => {
                        const icon = s.querySelector('i');
                        if (i < hoverRating) {
                            icon.className = 'fas fa-star';
                            s.style.color = '#ffdd55'; // Lighter yellow on hover
                        }
                    });
                });
                
                star.addEventListener('mouseleave', function() {
                    // Restore stars to selected rating
                    stars.forEach((s, i) => {
                        const icon = s.querySelector('i');
                        if (i < selectedRating) {
                            icon.className = 'fas fa-star';
                            s.style.color = '#ffc107';
                        } else {
                            icon.className = 'far fa-star';
                            s.style.color = '#ccc';
                        }
                    });
                });
            });
            
            // Submit button handler
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    const userId = submitBtn.dataset.userId || {{ user_data.id or 0 }};
                    console.log('Submit button clicked, rating: ' + selectedRating + ', userId: ' + userId);
                    
                    if (selectedRating > 0 && userId && userId != 0) {
                        // Simple AJAX call for rating
                        fetch('/api/rating', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                rated_user_id: parseInt(userId),
                                stars: selectedRating
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Rating response:', data);
                            if (data.status === 'success') {
                                console.log('Rating submitted successfully!');
                                submitBtn.style.display = 'none'; // Hide button after success
                            } else {
                                console.error('Rating error:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Rating submission error:', error);
                        });
                    } else {
                        console.log('Please select a rating first');
                    }
                });
            }
        } else {
            console.log('No star elements found - this is expected when viewing own profile');
        }
    });
        

        
        // Function to submit rating via AJAX
        function submitRating(userId, stars) {
            fetch('/api/rating', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest' // Common header for AJAX requests
                },
                body: JSON.stringify({
                    rated_user_id: userId,
                    stars: stars
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if(data.status === 'success') {
                    showMessage(data.message || 'Rating submitted successfully!', 'success');
                    // Hide submit button after successful submission
                    submitBtn.style.display = 'none';
                } else {
                    showMessage('Error submitting rating: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error submitting rating: ' + error.message, 'error');
            });
        }
        
        // Function to show message
        function showMessage(text, type) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageDiv.style.padding = '10px';
            messageDiv.style.margin = '10px 0';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.textAlign = 'center';
            
            if(type === 'success') {
                messageDiv.style.backgroundColor = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.borderColor = '#c3e6cb';
            } else {
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.borderColor = '#f5c6cb';
            }
            
            messageDiv.style.border = '1px solid';
            
            // Insert message in a safe location - add to the rating section div
            const ratingSection = document.querySelector('#rating-input')?.closest('div') ||
                                 document.querySelector('#submit-rating-btn')?.parentElement;
            
            if(ratingSection) {
                ratingSection.parentNode.insertBefore(messageDiv, ratingSection);
            } else {
                // Fallback: add to the beginning of the main content area
                document.querySelector('.card').prepend(messageDiv);
            }
            
            // Remove message after 3 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    });
</script>

{% endblock %}