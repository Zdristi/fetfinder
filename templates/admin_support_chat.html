{% extends "base.html" %}

{% block title %}{{ get_text('admin_support_chat') }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ get_text('admin_support_chat') }}</h1>
    
    <a href="{{ url_for('admin') }}" class="btn btn-outline">
        {{ get_text('back_to_admin_panel') }}
    </a>
    
    <div class="admin-support-container">
        <div class="tickets-panel">
            <h3>{{ get_text('support_tickets') }}</h3>
            <div class="ticket-list" id="ticket-list">
                <!-- Tickets will be loaded dynamically -->
                {% for ticket in open_tickets %}
                <div class="ticket-item {% if selected_ticket and ticket.id == selected_ticket.id %}selected{% endif %}" 
                     data-ticket-id="{{ ticket.id }}" onclick="selectTicket({{ ticket.id }})">
                    <div class="ticket-user">
                        <strong>{{ ticket.user.username }}</strong>
                        <span class="ticket-status {{ ticket.status }}">{{ ticket.status|upper }}</span>
                    </div>
                    <div class="ticket-preview">
                        {{ ticket.messages[0].content[:50] if ticket.messages else get_text('no_messages_yet') }}...
                    </div>
                    <div class="ticket-time">{{ ticket.updated_at.strftime('%m/%d %H:%M') }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="chat-panel">
            {% if selected_ticket %}
            <div class="chat-header">
                <div class="chat-user-info">
                    <h3>{{ get_text('support_chat_with') }} {{ selected_ticket.user.username }}</h3>
                    <span class="ticket-status {{ selected_ticket.status }}">{{ selected_ticket.status|upper }}</span>
                </div>
                <div class="ticket-actions">
                    {% if selected_ticket.status != 'closed' %}
                    <button class="btn btn-sm" onclick="closeTicket({{ selected_ticket.id }})">{{ get_text('close_ticket') }}</button>
                    {% endif %}
                </div>
            </div>
            
            <div class="chat-messages" id="admin-messages">
                {% for message in selected_ticket.messages %}
                <div class="message {% if message.is_admin %}sent{% else %}received{% endif %}">
                    <div class="message-content">
                        <p>{{ message.content }}</p>
                        <div class="message-time">{{ message.timestamp.strftime('%H:%M') }} - {% if message.is_admin %}{{ get_text('admin') }}{% else %}{{ message.sender.username }}{% endif %}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-form">
                    <textarea id="admin-message-input" placeholder="{{ get_text('type_your_message') }}" autocomplete="off"></textarea>
                    <button id="admin-send-button" class="btn send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="no-ticket-selected">
                <h3>{{ get_text('select_ticket_to_begin_chat') }}</h3>
                <p>{{ get_text('no_ticket_selected_info') }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.admin-support-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.tickets-panel {
    flex: 0 0 300px;
    background: var(--card-bg);
    border-radius: 10px;
    padding: 15px;
    height: calc(100vh - 200px);
    overflow-y: auto;
}

.ticket-list {
    margin-top: 10px;
}

.ticket-item {
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.ticket-item:hover {
    background-color: var(--hover-bg);
}

.ticket-item.selected {
    background-color: var(--primary-light);
    border-color: var(--primary);
}

.ticket-user {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.ticket-status {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.ticket-status.open {
    background-color: #d4edda;
    color: #155724;
}

.ticket-status.closed {
    background-color: #f8d7da;
    color: #721c24;
}

.ticket-preview {
    color: var(--muted-text);
    font-size: 0.9em;
    margin-bottom: 5px;
}

.ticket-time {
    font-size: 0.8em;
    color: var(--gray);
}

.chat-panel {
    flex: 1;
    background: var(--card-bg);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 200px);
    overflow: hidden;
}

.no-ticket-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted-text);
    text-align: center;
}

.chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-user-info h3 {
    margin: 0;
}

.ticket-actions {
    display: flex;
    gap: 10px;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
}

.message {
    max-width: 70%;
    margin-bottom: 15px;
    display: flex;
}

.message.sent {
    align-self: flex-end;
}

.message.received {
    align-self: flex-start;
}

.message-content {
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
}

.message.sent .message-content {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-bottom-right-radius: 5px;
}

.message.received .message-content {
    background: var(--bg-color);
    color: var(--text-color);
    border-bottom-left-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-top: 5px;
    text-align: right;
    color: var(--gray);
}

.message.sent .message-time {
    color: rgba(255,255,255,0.8);
}

.message.received .message-time {
    color: var(--gray);
}

.chat-input-container {
    padding: 15px;
    background: var(--card-bg);
    border-top: 1px solid var(--border-color);
}

.chat-input-form {
    display: flex;
    gap: 10px;
}

#admin-message-input {
    flex-grow: 1;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 30px;
    background: var(--bg-color);
    color: var(--text-color);
    outline: none;
    resize: none;
    height: 50px;
    max-height: 150px;
}

#admin-message-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(253, 41, 123, 0.1);
}

.send-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border: none;
    color: white;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .admin-support-container {
        flex-direction: column;
    }
    
    .tickets-panel {
        flex: 0 0 auto;
        height: 300px;
    }
}
</style>

<script>
let currentTicketId = null;

function selectTicket(ticketId) {
    // Update UI
    document.querySelectorAll('.ticket-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    const selectedElement = document.querySelector(`.ticket-item[data-ticket-id="${ticketId}"]`);
    if (selectedElement) {
        selectedElement.classList.add('selected');
    }
    
    // Load ticket messages
    currentTicketId = ticketId;
    window.location.href = `/admin_support_chat?ticket_id=${ticketId}`;
}

function closeTicket(ticketId) {
    if (confirm(translations.confirmCloseTicket)) {
        fetch(`/admin/close_support_ticket/${ticketId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error closing ticket: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error closing ticket');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('admin-message-input');
    const sendButton = document.getElementById('admin-send-button');
    
    if (currentTicketId) {
        // Handle send button click
        sendButton.addEventListener('click', function() {
            const content = messageInput.value.trim();
            if (!content) return;
            
            // Send message via AJAX
            fetch('/api/send_support_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticket_id: currentTicketId,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear input
                    messageInput.value = '';
                    messageInput.focus();
                    
                    // Reload page to show new message
                    location.reload();
                } else {
                    alert('Error sending message: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending message');
            });
        });
        
        // Handle Enter key (without Shift for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });
    }
});

// Poll for new messages every 5 seconds if on a ticket
if (currentTicketId) {
    setInterval(checkForNewMessages, 5000);
}

function checkForNewMessages() {
    if (currentTicketId) {
        fetch(`/api/support_messages/${currentTicketId}`)
        .then(response => response.json())
        .then(messages => {
            // Reload the chat to show new messages
            location.reload();
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
        });
    }
}

// Переведенные строки для JavaScript
const translations = {
    admin: "{{ get_text('admin') }}",
    closeTicket: "{{ get_text('close_ticket') }}",
    confirmCloseTicket: "{{ get_text('confirm_close_ticket') }}",
    supportChatWith: "{{ get_text('support_chat_with') }}"
};
</script>
{% endblock %}