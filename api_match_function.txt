@app.route('/api/match', methods=['POST'])
@login_required
def api_match():
    from models import UserSwipe
    from datetime import datetime
    data = request.get_json()
    user2 = data.get('user2')
    action = data.get('action')  # 'like' or 'dislike'
    
    is_mutual_match = False
    
    # Record the swipe action (like or dislike)
    existing_swipe = UserSwipe.query.filter_by(
        swiper_id=int(current_user.id), 
        swipee_id=int(user2)
    ).first()
    
    if existing_swipe:
        # Update existing swipe if needed
        existing_swipe.action = action
        existing_swipe.timestamp = datetime.utcnow()
    else:
        # Create new swipe record
        swipe = UserSwipe(
            swiper_id=int(current_user.id),
            swipee_id=int(user2),
            action=action
        )
        db.session.add(swipe)
    
    if action == 'like':
        # Check if match already exists
        existing_match = Match.query.filter_by(
            user_id=int(current_user.id), 
            matched_user_id=int(user2)
        ).first()
        
        if not existing_match:
            match = Match(
                user_id=int(current_user.id),
                matched_user_id=int(user2)
            )
            db.session.add(match)
            
            # Check if this is a mutual match
            reverse_match = Match.query.filter_by(
                user_id=int(user2),
                matched_user_id=int(current_user.id)
            ).first()
            
            # Return True if it's a mutual match
            is_mutual_match = reverse_match is not None
    
    # Commit all changes
    db.session.commit()

    response = {'status': 'success'}
    
    # If it's a mutual match, add notification
    if is_mutual_match:
        response['mutual_match'] = True
        response['matched_user_id'] = user2
        # Get matched user info
        matched_user = UserModel.query.get(int(user2))
        if matched_user:
            response['matched_user_name'] = matched_user.username
            response['matched_user_photo'] = matched_user.photo
    
    return jsonify(response)